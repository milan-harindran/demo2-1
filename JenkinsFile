pipeline {
    agent any
    stages {
        stage('Get Jenkins URL'){
            steps {
                echo "Jenkins URL --> $JENKINS_URL}"
            }
        }
        stage('Call External API'){
            steps {
                //we use groovy in script tag here to write the code 
                script {
                    def apiResponse
                    try{
                        apiResponse = httpRequest url: 'https://api.sampleapis.com/avatar/episodes',
                                                  contentType: 'APPLICATION_JSON',
                                                  consoleLogResponseBody: true,
                                                  httpMode: 'GET'
                         def episodes = readJSON text: apiResponse.content

                         if (episodes && episodes.size() > 0) {
                            def firstEpisode = episodes[0] // Access the first element (index 0) of the list

                            echo "Details of the first episode:"
                            echo "  ID: ${firstEpisode.id}"         // Access 'id' field
                            echo "  Name: ${firstEpisode.name}"       // Access 'name' field
                            echo "  Season: ${firstEpisode.season}"     // Access 'season' field
                            echo "  Episode: ${firstEpisode.episode}"   // Access 'episode' field
                            echo "  Air Date: ${firstEpisode.airDate}"  // Access 'airDate' field

                            // Example: Loop through a few episodes
                            echo "\n--- First 3 Episodes ---"
                            episodes.eachWithIndex { episode, index ->
                                if (index < 3) { // Limit to first 3 for brevity
                                    echo "Episode ${index + 1}:"
                                    echo "  ID: ${episode.id}"
                                    echo "  Name: ${episode.name}"
                                    echo "  Season: ${episode.season}, Episode: ${episode.episode}"
                                }
                            }
                        }
                    } catch (Exception e){
                        echo "Error calling external API: ${e.message}"
                        currentBuild.result = 'FAILURE'
                        error('Failed to call external API')
                    }
                }
            }
        }
    }
}